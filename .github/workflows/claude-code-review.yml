name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  claude-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: pr_diff
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Get the diff for this PR
          gh pr diff ${{ github.event.pull_request.number }} > pr_diff.txt

          # Check if diff is too large (Claude has context limits)
          DIFF_SIZE=$(wc -c < pr_diff.txt)
          if [ $DIFF_SIZE -gt 100000 ]; then
            echo "large_diff=true" >> $GITHUB_OUTPUT
            echo "Diff is too large ($DIFF_SIZE bytes), will summarize"
          else
            echo "large_diff=false" >> $GITHUB_OUTPUT
          fi

      - name: Review with Claude
        id: claude_review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          # Read the diff
          DIFF_CONTENT=$(cat pr_diff.txt)

          # Create the review prompt with Clean Code principles
          cat > review_prompt.txt << 'PROMPT_EOF'
You are an expert code reviewer specializing in Clean Code principles by Robert C. Martin. Review the following pull request diff and provide constructive feedback based on these principles:

## Clean Code Principles to Apply:

### 1. Meaningful Names
- Use intention-revealing names
- Avoid disinformation
- Make meaningful distinctions
- Use pronounceable and searchable names
- Avoid encodings and mental mapping

### 2. Functions
- Small! (Should do one thing well)
- One level of abstraction per function
- Descriptive names
- Prefer fewer arguments (0-2 is ideal, 3+ requires justification)
- No side effects
- Command Query Separation

### 3. Comments
- Comments should explain WHY, not WHAT
- Don't comment bad code - rewrite it
- Avoid redundant, misleading, or mandated comments
- TODO comments should be actionable

### 4. Formatting
- Consistent indentation and spacing
- Vertical openness between concepts
- Related code should be vertically dense
- Variables declared close to usage

### 5. Error Handling
- Use exceptions rather than return codes
- Don't return or pass null
- Provide context with exceptions

### 6. Objects and Data Structures
- Hide internal structure
- Objects expose behavior, hide data
- Data structures expose data, have no behavior
- Law of Demeter: don't talk to strangers

### 7. Classes
- Small! (Single Responsibility Principle)
- High cohesion
- Low coupling
- Organize for change

### 8. Tests
- Clean tests (readable, simple, expressive)
- One assert per test (guideline)
- F.I.R.S.T: Fast, Independent, Repeatable, Self-validating, Timely

## Review Format:

Provide your review in the following sections:

### Summary
Brief overview of the changes and overall code quality.

### Strengths
What the code does well according to Clean Code principles.

### Issues Found
List any violations of Clean Code principles with:
- Severity: Critical / Important / Minor
- File and line reference
- Principle violated
- Specific issue
- Suggested improvement

### Recommendations
General advice for improving code quality.

---

## Pull Request Diff:

```diff
DIFF_CONTENT_PLACEHOLDER
```

Please provide a thorough but concise review. Focus on significant issues rather than nitpicks. Be constructive and educational.
PROMPT_EOF

          # Replace the placeholder with actual diff content
          sed -i "s/DIFF_CONTENT_PLACEHOLDER/$(echo "$DIFF_CONTENT" | sed 's/[\/&]/\\&/g' | tr '\n' '\r')/" review_prompt.txt
          tr '\r' '\n' < review_prompt.txt > review_prompt_final.txt

          # Call Claude API
          REVIEW_RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            --header "x-api-key: $ANTHROPIC_API_KEY" \
            --header "anthropic-version: 2023-06-01" \
            --header "content-type: application/json" \
            --data @- << EOF
{
  "model": "claude-sonnet-4-20250514",
  "max_tokens": 4096,
  "messages": [
    {
      "role": "user",
      "content": $(cat review_prompt_final.txt | jq -Rs .)
    }
  ]
}
EOF
          )

          # Extract the review content
          REVIEW_TEXT=$(echo "$REVIEW_RESPONSE" | jq -r '.content[0].text')

          # Check if review was successful
          if [ -z "$REVIEW_TEXT" ] || [ "$REVIEW_TEXT" = "null" ]; then
            echo "Error: Failed to get review from Claude"
            echo "Response: $REVIEW_RESPONSE"
            exit 1
          fi

          # Save review to file for next step
          echo "$REVIEW_TEXT" > claude_review.md

      - name: Post review comment
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Create the comment body with header
          cat > comment.md << 'COMMENT_EOF'
## Claude Code Review (Clean Code Analysis)

COMMENT_EOF

          cat claude_review.md >> comment.md

          cat >> comment.md << 'COMMENT_EOF'

---
*This review was automatically generated by Claude Sonnet 4 using Clean Code principles by Robert C. Martin.*
COMMENT_EOF

          # Post the comment
          gh pr comment ${{ github.event.pull_request.number }} --body-file comment.md

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-artifacts
          path: |
            pr_diff.txt
            claude_review.md
            comment.md
