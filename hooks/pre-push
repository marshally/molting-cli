#!/bin/bash
#
# Pre-push hook that:
# 1. Runs linters on entire codebase (black, ruff, mypy)
# 2. Checks beads JSONL for uncommitted changes (if in a bd workspace)
# 3. Prevents push if any checks fail
#
# This catches issues that pre-commit hooks miss since they only check staged files.
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}========================================${NC}"
echo -e "${BLUE}Running pre-push checks on entire codebase...${NC}"
echo -e "${BLUE}========================================${NC}"
echo ""

# ============================================================
# Lint checks (matches GitHub Actions CI)
# ============================================================

# Check formatting with black
echo -e "${YELLOW}â†’ Checking formatting with black...${NC}"
if ! poetry run black --check --exclude '/(\.venv|tests/fixtures)/' . 2>&1; then
    echo ""
    echo -e "${RED}âœ— Black formatting check failed!${NC}"
    echo -e "${YELLOW}ðŸ’¡ Run 'make format' or 'poetry run black .' to fix formatting issues.${NC}"
    exit 1
fi
echo -e "${GREEN}âœ“ Black formatting OK${NC}"
echo ""

# Lint with ruff
echo -e "${YELLOW}â†’ Linting with ruff...${NC}"
if ! poetry run ruff check --exclude '.venv' --exclude 'tests/fixtures' . 2>&1; then
    echo ""
    echo -e "${RED}âœ— Ruff linting failed!${NC}"
    echo -e "${YELLOW}ðŸ’¡ Run 'make format' or 'poetry run ruff check . --fix' to fix linting issues.${NC}"
    exit 1
fi
echo -e "${GREEN}âœ“ Ruff linting OK${NC}"
echo ""

# Type check with mypy
echo -e "${YELLOW}â†’ Type checking with mypy...${NC}"
if ! poetry run mypy molting/ --exclude 'tests/fixtures/' 2>&1; then
    echo ""
    echo -e "${RED}âœ— Mypy type checking failed!${NC}"
    echo -e "${YELLOW}ðŸ’¡ Fix type errors before pushing.${NC}"
    exit 1
fi
echo -e "${GREEN}âœ“ Type checking OK${NC}"
echo ""

# ============================================================
# Beads JSONL checks (if in a bd workspace)
# ============================================================

if [ -d .beads ]; then
    echo -e "${YELLOW}â†’ Checking beads JSONL...${NC}"

    # Optionally flush pending bd changes so they surface in JSONL
    # This prevents the race where a debounced flush lands after the check
    if command -v bd >/dev/null 2>&1; then
        bd sync --flush-only >/dev/null 2>&1 || true
    fi

    # Collect all tracked or existing JSONL files (supports both old and new names)
    FILES=""
    for f in .beads/beads.jsonl .beads/issues.jsonl; do
        # Include file if it exists in working tree OR is tracked by git (even if deleted)
        if git ls-files --error-unmatch "$f" >/dev/null 2>&1 || [ -f "$f" ]; then
            FILES="$FILES $f"
        fi
    done

    # Check for any uncommitted changes using porcelain status
    # This catches: staged, unstaged, untracked, deleted, renamed, and conflicts
    if [ -n "$FILES" ]; then
        # shellcheck disable=SC2086
        if [ -n "$(git status --porcelain -- $FILES 2>/dev/null)" ]; then
            echo ""
            echo -e "${RED}âœ— Beads JSONL has uncommitted changes${NC}"
            echo ""
            echo -e "${YELLOW}You made changes to bd issues between your last commit and this push.${NC}"
            echo -e "${YELLOW}Please commit the updated JSONL before pushing:${NC}"
            echo ""
            # shellcheck disable=SC2086
            echo -e "  git add $FILES"
            echo '  git commit -m "Update bd JSONL"'
            echo "  git push"
            echo ""
            exit 1
        fi
    fi

    echo -e "${GREEN}âœ“ Beads JSONL OK${NC}"
    echo ""
fi

echo -e "${BLUE}========================================${NC}"
echo -e "${GREEN}âœ… All pre-push checks passed!${NC}"
echo -e "${BLUE}========================================${NC}"
exit 0
