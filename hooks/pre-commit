#!/bin/bash
#
# Pre-commit hook that:
# 1. Stashes unstaged changes
# 2. Runs linters in autofix mode (black, ruff)
# 3. Runs type checker (mypy)
# 4. Allows commit if all checks pass
# 5. Restores stashed changes

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Get the list of staged Python files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No Python files staged, skipping linters${NC}"
    exit 0
fi

# Stash unstaged changes (including untracked files)
echo -e "${YELLOW}Stashing unstaged changes...${NC}"
STASH_NAME="pre-commit-$(date +%s)"
git stash push -k -u -m "$STASH_NAME" > /dev/null 2>&1
STASHED=$?

# Function to restore stash and exit
cleanup_and_exit() {
    exit_code=$1
    if [ $STASHED -eq 0 ]; then
        echo -e "${YELLOW}Restoring stashed changes...${NC}"
        git stash pop > /dev/null 2>&1 || true
    fi
    exit $exit_code
}

# Trap to ensure stash is always popped
trap 'cleanup_and_exit $?' EXIT

echo -e "${YELLOW}Running black (autofix)...${NC}"
if ! black $STAGED_FILES; then
    echo -e "${RED}Black formatting failed!${NC}"
    exit 1
fi

echo -e "${YELLOW}Running ruff (autofix)...${NC}"
if ! ruff check --fix $STAGED_FILES; then
    echo -e "${RED}Ruff linting failed!${NC}"
    exit 1
fi

echo -e "${YELLOW}Running mypy (type checking)...${NC}"
# Filter out conftest.py and fixtures to avoid "found twice" error
MYPY_FILES=$(echo "$STAGED_FILES" | tr ' ' '\n' | grep -v 'conftest\.py$' | grep -v 'tests/fixtures/' | tr '\n' ' ')
if [ -n "$MYPY_FILES" ]; then
    if ! mypy $MYPY_FILES; then
        echo -e "${RED}Mypy type checking failed!${NC}"
        exit 1
    fi
fi

# Add any files that were auto-fixed
for file in $STAGED_FILES; do
    if [ -f "$file" ]; then
        git add "$file"
    fi
done

echo -e "${GREEN}All linting checks passed!${NC}"
exit 0
