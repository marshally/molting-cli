#!/bin/bash
#
# Pre-commit hook that:
# 1. Stashes unstaged changes
# 2. Runs linters in autofix mode (black, ruff)
# 3. If linters made changes, commits them separately
# 4. Runs type checker (mypy)
# 5. Restores stashed changes
#
set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running pre-commit checks...${NC}"

# Get the list of staged Python files (excluding fixtures)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' | grep -v 'tests/fixtures/' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${GREEN}No Python files staged, skipping linters${NC}"
    exit 0
fi

# Stash unstaged changes (including untracked files)
echo -e "${YELLOW}Stashing unstaged changes...${NC}"
STASH_NAME="pre-commit-$(date +%s)"
git stash push -k -u -m "$STASH_NAME" > /dev/null 2>&1
STASHED=$?

# Function to restore stash and exit
cleanup_and_exit() {
    exit_code=$1
    if [ $STASHED -eq 0 ]; then
        echo -e "${YELLOW}Restoring stashed changes...${NC}"
        git stash pop > /dev/null 2>&1 || true
    fi
    exit $exit_code
}

# Trap to ensure stash is always popped
trap 'cleanup_and_exit $?' EXIT

echo -e "${YELLOW}Running black (autofix)...${NC}"
if ! black $STAGED_FILES; then
    echo -e "${RED}Black formatting failed!${NC}"
    exit 1
fi

echo -e "${YELLOW}Running ruff (autofix)...${NC}"
if ! ruff check --fix $STAGED_FILES; then
    echo -e "${RED}Ruff linting failed!${NC}"
    exit 1
fi

# Check if linters made any changes
LINTER_CHANGES=$(git diff --name-only $STAGED_FILES || true)

if [ -n "$LINTER_CHANGES" ]; then
    echo -e "${BLUE}Linters made changes to: $(echo $LINTER_CHANGES | tr '\n' ' ')${NC}"

    # Stage the linter changes
    git add $STAGED_FILES

    # Create a separate commit for the linter fixes
    echo -e "${BLUE}Creating separate commit for linter auto-fixes...${NC}"
    git commit --no-verify -m "Auto-fix: black and ruff formatting

Applied automatic formatting and linting fixes.

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude <noreply@anthropic.com>"

    echo -e "${GREEN}Linter fixes committed separately.${NC}"
    echo -e "${YELLOW}Please run 'git commit' again to commit your changes.${NC}"
    exit 1
fi

echo -e "${YELLOW}Running mypy (type checking)...${NC}"
# Filter out conftest.py and fixtures to avoid "found twice" error
MYPY_FILES=$(echo "$STAGED_FILES" | tr ' ' '\n' | grep -v 'conftest\.py$' | grep -v 'tests/fixtures/' | tr '\n' ' ')
if [ -n "$MYPY_FILES" ]; then
    if ! mypy $MYPY_FILES; then
        echo -e "${RED}Mypy type checking failed!${NC}"
        exit 1
    fi
fi

echo -e "${GREEN}All linting checks passed!${NC}"
exit 0
